<!DOCTYPE html>
<html>
  <head>
    <title>PersonalFinance</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body>
    <div>
      <canvas id="myChart"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      const ctx = document.getElementById('myChart');
      const months = [
        "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec",
      ];

      fetch('/transactions', {
        headers: {
          'Content-Type': "application/json",
        },
      })
      .then((response) => response.json())
      .then((data) => {
        data = data
        .filter((txn) => txn.direction === "debit")
        .sort((a, b) => {
          if (a.posted_on < b.posted_on) {
            return -1;
          } else if (a.posted_on > b.posted_on) {
            return 1;
          }
          return 0;
        });

        const monthlySpending = new Array(12).fill(0);
        data.forEach((txn) => {
          const month = new Date(txn.posted_on).getUTCMonth();
          monthlySpending[month] += txn.amount / 100.0;
        });

        window.transactions = data;
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: months,
            datasets: [{
              label: 'Amount',
              data: monthlySpending,
              borderWidth: 1
            }]
          },
          options: {
            plugins: {
              title: {
                display: true,
                text: "Monthly spend",
              },
            },
            scales: {
              y: {
                display: true,
                beginAtZero: true,
                type: "logarithmic",
              }
            }
          }
        });
      });
    </script>

    <table>
      <tr>
        <th scope="col">Posted Date</th>
        <th scope="col">Description</th>
        <th scope="col">Amount</th>
      </tr>
      <% @transactions.each do |t| %>
        <tr>
          <td scope="row">
            <%= t.posted_on %>
          </td>
          <td>
            <%= t.description %>
          </td>
          <td>
            <% if t.direction == "credit" %>
              <%= "#{t.amount / 100.0}" %>
            <% elsif t.direction == "debit" %>
              <%= "#{-t.amount / 100.0}" %>
            <% end %>
          </td>
        <tr>
      <% end %>
    </table>
  </body>
</html>
